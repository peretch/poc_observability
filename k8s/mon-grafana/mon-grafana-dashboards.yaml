apiVersion: v1
kind: ConfigMap
metadata:
  name: mon-grafana-dashboards
  labels:
    app: mon-grafana
data:
  auth-metrics.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Authentication Metrics",
        "tags": ["auth", "microservices"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Authentication Attempts Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(auth_attempts_total[5m])",
                "legendFormat": "{{type}} - {{status}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "displayMode": "list",
                  "orientation": "horizontal"
                },
                "mappings": [],
                "thresholds": {
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "red",
                      "value": 10
                    }
                  ]
                }
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Authentication Success Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(auth_attempts_total{status=\"success\"}[5m]) / rate(auth_attempts_total[5m]) * 100",
                "legendFormat": "Success Rate %"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100,
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {
                      "color": "red",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 80
                    },
                    {
                      "color": "green",
                      "value": 95
                    }
                  ]
                }
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "Authentication Attempts by Type",
            "type": "piechart",
            "targets": [
              {
                "expr": "sum by (type) (auth_attempts_total)",
                "legendFormat": "{{type}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 8,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "Active Sessions",
            "type": "stat",
            "targets": [
              {
                "expr": "active_sessions_total",
                "legendFormat": "Active Sessions"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 100
                    },
                    {
                      "color": "red",
                      "value": 500
                    }
                  ]
                }
              }
            },
            "gridPos": {
              "h": 8,
              "w": 8,
              "x": 8,
              "y": 8
            }
          },
          {
            "id": 5,
            "title": "Authentication Attempts Over Time",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(auth_attempts_total[1m])",
                "legendFormat": "{{type}} - {{status}} - {{provider}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 16,
              "x": 16,
              "y": 8
            }
          },
          {
            "id": 6,
            "title": "Failed Authentication Attempts",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(auth_attempts_total{status=\"failure\"}[5m])",
                "legendFormat": "{{type}} - {{provider}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 16
            }
          },
          {
            "id": 7,
            "title": "OAuth Provider Usage",
            "type": "piechart",
            "targets": [
              {
                "expr": "sum by (provider) (auth_attempts_total{type=\"oauth\"})",
                "legendFormat": "{{provider}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 16
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s"
      }
    }
  http-performance.json: |
    {
      "dashboard": {
        "id": null,
        "title": "HTTP Performance Metrics",
        "tags": ["http", "performance", "microservices"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(http_requests_total[5m])",
                "legendFormat": "{{method}} {{route}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Response Time (95th percentile)",
            "type": "stat",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 0.5
                    },
                    {
                      "color": "red",
                      "value": 2
                    }
                  ]
                }
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "HTTP Status Codes",
            "type": "piechart",
            "targets": [
              {
                "expr": "sum by (status_code) (http_requests_total)",
                "legendFormat": "{{status_code}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 8,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "Request Duration Over Time",
            "type": "timeseries",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "50th percentile"
              },
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile"
              },
              {
                "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "99th percentile"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 16,
              "x": 8,
              "y": 8
            }
          },
          {
            "id": 5,
            "title": "Error Rate",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(http_requests_total{status_code=~\"5..\"}[5m])",
                "legendFormat": "5xx errors"
              },
              {
                "expr": "rate(http_requests_total{status_code=~\"4..\"}[5m])",
                "legendFormat": "4xx errors"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 16
            }
          },
          {
            "id": 6,
            "title": "Top Routes by Request Count",
            "type": "table",
            "targets": [
              {
                "expr": "topk(10, sum by (route) (rate(http_requests_total[5m])))",
                "legendFormat": "{{route}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 16
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s"
      }
    }
  system-metrics.json: |
    {
      "dashboard": {
        "id": null,
        "title": "System Metrics",
        "tags": ["system", "nodejs", "microservices"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Memory Usage",
            "type": "timeseries",
            "targets": [
              {
                "expr": "nodejs_heap_size_total_bytes",
                "legendFormat": "Heap Size"
              },
              {
                "expr": "nodejs_heap_size_used_bytes",
                "legendFormat": "Heap Used"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "bytes"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "CPU Usage",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(nodejs_process_cpu_user_seconds_total[5m]) * 100",
                "legendFormat": "CPU User %"
              },
              {
                "expr": "rate(nodejs_process_cpu_system_seconds_total[5m]) * 100",
                "legendFormat": "CPU System %"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "Event Loop Lag",
            "type": "timeseries",
            "targets": [
              {
                "expr": "nodejs_eventloop_lag_seconds",
                "legendFormat": "Event Loop Lag"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 0.01
                    },
                    {
                      "color": "red",
                      "value": 0.1
                    }
                  ]
                }
              }
            },
            "gridPos": {
              "h": 8,
              "w": 8,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "HTTP Connections",
            "type": "stat",
            "targets": [
              {
                "expr": "nodejs_http_requests_total",
                "legendFormat": "Total Requests"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 8,
              "x": 8,
              "y": 8
            }
          },
          {
            "id": 5,
            "title": "Garbage Collection",
            "type": "timeseries",
            "targets": [
              {
                "expr": "rate(nodejs_gc_duration_seconds_total[5m])",
                "legendFormat": "GC Duration"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 8,
              "x": 16,
              "y": 8
            }
          },
          {
            "id": 6,
            "title": "Process Uptime",
            "type": "stat",
            "targets": [
              {
                "expr": "nodejs_process_start_time_seconds",
                "legendFormat": "Start Time"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "dateTimeFromNow"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 16
            }
          },
          {
            "id": 7,
            "title": "Open File Descriptors",
            "type": "timeseries",
            "targets": [
              {
                "expr": "nodejs_open_file_descriptors",
                "legendFormat": "Open FDs"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 16
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s"
      }
    }
